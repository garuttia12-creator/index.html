<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Nilai Akhir | PJTJ</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
            margin: 0; font-family: 'Poppins', sans-serif;
            background: linear-gradient(180deg, #1e2f8f, #0b1c4d);
            color: #fff; min-height: 100vh;
        }
        .container { width: 100%; max-width: 900px; margin: auto; padding: 60px 15px; }
        .card { 
            background: rgba(255, 255, 255, 0.1); border-radius: 22px; padding: 25px; 
            border: 1px solid rgba(255, 255, 255, .15); backdrop-filter: blur(10px); 
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }
        .table-container { width: 100%; overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        thead th { padding: 15px; background: rgba(255, 255, 255, .1); text-align: center; color: #f8c471; }
        td { padding: 15px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, .05); }
        .nilai-besar {
            font-size: 70px; font-weight: 800; margin: 10px 0;
            background: linear-gradient(90deg, #ff9a3c, #ff3d3d);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .blok-header { background: rgba(248, 196, 113, 0.1); font-weight: bold; color: #f8c471; text-align: left !important; }
        .sub-total { background: rgba(76, 201, 240, 0.1); font-weight: bold; color: #4cc9f0; }
        .btn-nav {
            background: rgba(255,255,255,0.1); color: white; border: none; padding: 10px 20px; 
            border-radius: 20px; cursor: pointer; text-decoration: none; display: inline-block; margin-bottom: 20px;
            transition: 0.3s;
        }
        .btn-nav:hover { background: rgba(255,255,255,0.2); }
        #btnSertifikat {
            background: linear-gradient(90deg, #27ae60, #2ecc71); color: white; border: none;
            padding: 15px 30px; border-radius: 30px; font-weight: bold; cursor: pointer;
            margin-top: 20px; display: none; text-decoration: none;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        }
    </style>
</head>
<body>

<div class="container">
    <a href="../dashboard.html" class="btn-nav"><i class="fa-solid fa-arrow-left"></i> Kembali ke Dashboard</a>
    
    <div class="card">
        <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="margin:0;">üìò Laporan Hasil Belajar</h1>
            <p style="opacity: 0.7;">Akumulasi nilai akhir materi </p>
            <div id="nilaiAkhir" class="nilai-besar">0</div>
            <p id="statusTeks" style="font-size: 18px; font-weight: 500;"></p>
            <a href="sertifikat.html" id="btnSertifikat">üéì DOWNLOAD SERTIFIKAT</a>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 50px;">NO</th>
                        <th style="text-align: left;">INDIKATOR</th>
                        <th>Skor Anda</th>
                    </tr>
                </thead>
                <tbody id="tabelBody">
                    <tr><td colspan="3" style="padding: 50px;">Sedang memvalidasi data siswa...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
    // MENGGUNAKAN IMPORT YANG SAMA DENGAN LEADERBOARD
    import { db } from "../js/firebase-config.js";
    import { ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const auth = getAuth();

    // Jalankan pengecekan auth
    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("Login sebagai:", user.uid);
            ambilDataSiswa(user.uid);
        } else {
            console.warn("User tidak terdeteksi, dialihkan ke login.");
            window.location.href = "login.html";
        }
    });

    async function ambilDataSiswa(uid) {
        try {
            // Ambil Master Materi dan Progres spesifik User tersebut
            const [materiSnap, userSnap] = await Promise.all([
                get(ref(db, 'materi')),
                get(ref(db, `users/${uid}/progres`))
            ]);

            const tbody = document.getElementById('tabelBody');

            if (!materiSnap.exists()) {
                tbody.innerHTML = "<tr><td colspan='3'>Belum ada daftar materi di database.</td></tr>";
                return;
            }

            const materiData = materiSnap.val();
            const progresData = userSnap.val() || {};

            // Mengurutkan materi berdasarkan id_urut
            const listMateri = Object.keys(materiData).map(key => ({
                id_db: key,
                ...materiData[key]
            })).sort((a, b) => (a.id_urut || 0) - (b.id_urut || 0));

            tbody.innerHTML = "";
            let totalSkorKumulatif = 0;
            let blokSelesaiCount = 0;

            // Logika Loop per Blok (4 materi per blok)
            for (let i = 0; i < listMateri.length; i += 4) {
                const group = listMateri.slice(i, i + 4);
                const nomorBlok = Math.floor(i / 4) + 1;

                // Header Blok
                const hRow = document.createElement('tr');
                hRow.className = 'blok-header';
                hRow.innerHTML = `<td colspan="3"><i class="fa-solid fa-layer-group"></i> MERANCANG TOPOLOGI JARINGAN ${nomorBlok}</td>`;
                tbody.appendChild(hRow);

                let skorBlok = 0;
                let materiTuntas = 0;

                group.forEach(m => {
                    // Ambil skor dari folder progres sesuai ID materi
                    const p = progresData[m.id_db];
                    const skor = (p && p.skor !== undefined) ? parseInt(p.skor) : null;

                    if (skor !== null) {
                        skorBlok += skor;
                        materiTuntas++;
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${m.id_urut || '-'}</td>
                        <td style="text-align: left;">${m.judul}</td>
                        <td style="font-weight:bold; color:${skor >= 70 ? '#2ecc71' : '#ff6f61'}">
                            ${skor !== null ? skor : '<span style="opacity:0.3">Belum Ada</span>'}
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                // Baris Rata-Rata per Blok
                const fRow = document.createElement('tr');
                fRow.className = 'sub-total';
                if (materiTuntas === group.length && group.length > 0) {
                    const rataRata = Math.round(skorBlok / group.length);
                    fRow.innerHTML = `<td colspan="2">RATA-RATA MATERI ${nomorBlok}</td><td>${rataRata}</td>`;
                    totalSkorKumulatif += rataRata;
                    blokSelesaiCount++;
                } else {
                    fRow.innerHTML = `<td colspan="2">RATA-RATA MATERI ${nomorBlok}</td><td style="font-size:11px; color:#f8c471">Belum Lengkap (${materiTuntas}/${group.length})</td>`;
                }
                tbody.appendChild(fRow);
            }

            // Hitung Nilai Final (Rata-rata dari nilai semua blok yang sudah selesai)
            const nilaiFinal = blokSelesaiCount > 0 ? Math.round(totalSkorKumulatif / blokSelesaiCount) : 0;
            document.getElementById('nilaiAkhir').innerText = nilaiFinal;

            const statusTeks = document.getElementById('statusTeks');
            const btnSertif = document.getElementById('btnSertifikat');

            if (blokSelesaiCount >= 1 && nilaiFinal >= 70) {
                statusTeks.innerHTML = "‚úÖ Selamat Anda Lulus!";
                statusTeks.style.color = "#2ecc71";
                btnSertif.style.display = "inline-block";
            } else {
                statusTeks.innerHTML = "‚ùå Belum Memenuhi Syarat Kelulusan (Minimal Skor 70)";
                statusTeks.style.color = "#f8c471";
                btnSertif.style.display = "none";
            }

        } catch (error) {
            console.error("Error Detail:", error);
            document.getElementById('tabelBody').innerHTML = `<tr><td colspan="3" style="color:red">Terjadi kesalahan: ${error.message}</td></tr>`;
        }
    }
</script>

</body>

</html>


